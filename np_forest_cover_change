/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var wdpa_parks = ee.FeatureCollection("WCMC/WDPA/current/polygons"),
    global_forest_change = ee.Image("UMD/hansen/global_forest_change_2024_v1_12");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// Visualise the PAs
Map.addLayer(wdpa_parks);
// Add the Global Forest Change (Hansen et al.) dataset
// Map.addLayer(global_forest_change);
// Auto set the scale for our calculations to 30m, the scale of the Hansen dataset
var scale = global_forest_change.projection().nominalScale();

// Create a variable for the original tree cover in 2000
var treeCover = global_forest_change.select(['treecover2000']);
// Convert tree cover layer - treeCover is in hundreds of hectares, but the loss and gain layers are just in hectares
treeCover = treeCover.divide(100);
// Create a variable for forest loss
var loss = global_forest_change.select(['loss']);
// Create a variable for forest gain
var gain = global_forest_change.select(['gain']);

// Add the tree cover layer in light grey
Map.addLayer(treeCover.updateMask(treeCover),
    {palette: ['D0D0D0', '00FF00'], max: 100}, 'Forest Cover');
// Add the loss layer in pink
Map.addLayer(loss.updateMask(loss),
            {palette: ['#BF619D']}, 'Loss');
// Add the gain layer in yellow
Map.addLayer(gain.updateMask(gain),
            {palette: ['#CE9E5D']}, 'Gain');

// var units are no. of pixels, dividing by 1m means the final result is in km2
var areaCover = treeCover.multiply(ee.Image.pixelArea())
                .divide(1000000).select([0],["areacover"]);
var areaLoss = loss.gt(0).multiply(ee.Image.pixelArea()).multiply(treeCover)
              .divide(1000000).select([0],["arealoss"]);
var areaGain = gain.gt(0).multiply(ee.Image.pixelArea()).multiply(treeCover)
              .divide(1000000).select([0],["areagain"]);

// Clean parks db to only include designation "National Park" and avoid duplication entries
wdpa_parks = wdpa_parks
  .filter(ee.Filter.eq("DESIG_ENG", "National Park"));
              
// Create a variable that has the polygons for just a few national parks and nature reserves
var wdpa_parks = wdpa_parks.filter(ee.Filter.or(
    ee.Filter.eq("NAME", "Yorkshire Dales"),
    ee.Filter.eq("NAME", "North York Moors"),
    ee.Filter.eq("NAME", "Lake District"),
    ee.Filter.eq("NAME", "Northumberland")));

// Sum the values of loss pixels.
var statsLoss = areaLoss.reduceRegions({
  reducer: ee.Reducer.sum(),
  collection: wdpa_parks,
  scale: scale
});

// Sum the values of gain pixels.
var statsGain = areaGain.reduceRegions({
  reducer: ee.Reducer.sum(),
  collection: wdpa_parks,
  scale: scale
});

// Initiate export of results table to GDrive csv (see Tasks tab to the right)
// Results stored in penultimate column entitled 'sum'
Export.table.toDrive({
  collection: statsLoss,
  description: 'NP_forest_loss'});
  
Export.table.toDrive({
  collection: statsGain,
  description: 'NP_forest_gain'});